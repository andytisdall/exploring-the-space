doctype html
html(lang="en")
head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel="preconnect" href="https://fonts.gstatic.com")
    link(href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel="stylesheet")
    style
        include ../style.css
    title Greenhouse
body
    div(class='upload-container hidden')
        div(class='upload-progress')
            div(class='upload-image')
                p UPLOADING...
                img(class='windmill' src='windmill.gif' height='120px' width='110px')
    div(class='container')
        if errorMessage
            div(class='error') #{errorMessage}
        div(class="marqee")            
            h1 Apprehenchmen
            div(class="add") Add a Tier
                div(class='addbox hidden tier-add')
                    form(method='POST' action='')
                        label(for='tierName') Tier Name:
                        input(type='text' spellcheck='false' name='tierName' required='true' value='')
                        input(type='hidden' name='dataID' value='tier-0')
                        button(type='submit') OK
                        div(class="add")

        hr 
        each tier in tiers
            div(class="row tier" id=tier.id)
                div(class="marqee")
                    div(class='row-name')
                        img(class='arrow' src='right-arrow.svg' id=('arrow-' + tier.id))
                        h2 #{tier.name}     
                        div(class='song-count') #{tier.trackList.length} songs
                        div(class='song-count' id='tiertime'+tier.id)
                    div(class='tier-display')
                        div(class="edit" id=('edittier-' + tier.id)) Edit This Tier
                            div(class='addbox hidden')
                                form(method='POST' action='/edit')
                                    label(for='tierName') Tier Name:
                                    input(type='text' spellcheck='false' name='tierName' required='true' value=tier.name)
                                    label(for='tierPosition') Tier Position:
                                    select(name='tierPosition')
                                        option(selected disabled value=tier.position) #{tier.position}
                                        each item in tiers
                                            option(value=item.position) #{item.position}
                                    input(type='hidden' name='dataID' value='tier-' + tier.id)
                                    p
                                    button(type='submit') OK
                        div(class="add" id=('addtitle-' + tier.id)) Add a Song to this Tier
                            div(class='addbox hidden')
                                form(method='POST' action='' class='add-form')
                                    label(for='titleName') Title:
                                    input(type='text' spellcheck='false' name='titleName' required='true' value='')
                                    input(type='hidden' name='dataID' value='title-' + tier.id)
                                    button(type='submit') OK
                        a(class = 'delete' href=('/delete/tier/' + tier.id)) delete this tier
                hr
                div(class='titlecontainer hidden' id=('title-' + tier.id))
                    each title in tier.trackList
                        div(class="row title" id=title.id)
                            div(class='title-margin')
                                div(class="marqee")
                                    div(class='row-name')
                                        img(class='arrow' src='right-arrow.svg' id=('arrow-' + title.id))
                                        div(class='name-spot')
                                            h3 #{title.title}
                                        div(class='playcontainer')
                                            if title.versions.length > 0
                                                - const thisVersion = title.versions.find(v => v.current)
                                                if thisVersion.songs.length > 0
                                                    - const thisSong = thisVersion.songs.find(s => s.latest)                  
                                                    audio(controls src='/audio/' + thisSong.id + '.mp3' class='player' id='player-' + tier.id + '-' + title.id)
                                    div(class='tier-display')
                                        div(class="edit" id=('edittitle-' + title.id)) Edit This Title
                                            div(class='addbox hidden')
                                                form(method='POST' action='/edit' class='add-form')
                                                    label(for='titleName') Title:
                                                    input(type='text' spellcheck='false' name='titleName' required='true' value=title.title)
                                                    label(for='moveTier') Change Tier:
                                                    select(name='moveTier')
                                                        option(selected value=tier.id) #{tier.name}
                                                        if tiers.length > 1
                                                            - let tierlist = tiers.filter(t => t.id !== tier.id)
                                                            each otherTier in tierlist
                                                                option(value=otherTier.id) #{otherTier.name}
                                                    br
                                                    br                                                            
                                                    input(type='hidden' name='dataID' value='title-' + title.id)
                                                    input(type='hidden' name='parentID' value=tier.id)
                                                    button(type='submit') OK
                                        a(class = 'delete' href=('/delete/title/' + title.id + '/' + tier.id)) delete this title
    
                                div(class='versioncontainer hidden' id=('version-' + title.id))
                                    if title.versions.length > 0 
                                        div(class='version-info')
                                            div(class='info-header')
                                                div(class='info-name')
                                                    - const thisVersion = title.versions.find(v => v.current) 
                                                    p Version:
                                                    h5 #{thisVersion.name}
                                                    form(class="row version-select" method='POST' action='/change-version')
                                                        input(type='hidden' name='currentVersion' value=thisVersion.id)
                                                        label(for='changeVersion' class='selector') choose version:   
                                                        select(name="changeVersion" onchange='this.form.submit()')
                                                            option(value='placeholder' selected disabled) ---
                                                            - const versionDates = title.versions.map(v => [v.name, v.id])
                                                            each version in versionDates
                                                                - let short = version[0].length > 14 ? version[0].slice(0,15) + '...' : version[0]
                                                                option(value=version[1]) #{short}
                                                div(class='note-box')
                                                    p Notes:
                                                    p(class='notes') #{thisVersion.notes}   
                                            
                                            div(class='info-buttons')
                                                div(class="edit" id=('editversion-' + thisVersion.id)) Edit This Version
                                                        div(class='addbox hidden add-version')
                                                            form(method='POST' action='/edit')
                                                                label(for='versionName') Name:
                                                                input(type='text' spellcheck='false' name='versionName' required='true' value=thisVersion.name)
                                                                label(for='versionName') Version Notes:
                                                                input(type='textarea' spellcheck='false' name='versionNotes' value=thisVersion.notes)
                                                                label(for="versionCurrent") Current version
                                                                input(type="checkbox" name="versionCurrent" checked=thisVersion.current ? 'checked' : '')
                                                                input(type='hidden' name='dataID' value='version-' + thisVersion.id)
                                                                button(type='submit') OK
                                                div(class="add" id=('addversion-' + title.id)) Add a New Version
                                                    div(class='addbox hidden add-version')
                                                        form(method='POST' action='')
                                                            label(for='versionName') Name:
                                                            input(type='text' spellcheck='false' name='versionName' required='true' value='')
                                                            label(for='versionName') Version Notes:
                                                            input(type='textarea' spellcheck='false' name='versionNotes' value='')
                                                            label(for="versionCurrent") Current version
                                                            input(type="checkbox" name="versionCurrent" checked)
                                                            input(type='hidden' name='dataID' value='version-' + title.id)
                                                            button(type='submit') OK
                                                a(class = 'delete' href=('/delete/version/' + thisVersion.id + '/' + title.id)) delete this version
                                        if thisVersion.songs.length > 0     
                                            div(class="row song-con"  id=('song-' + thisVersion.id))
                                                div(class='info-header')
                                                    div(class='info-name')
                                                    
                                                        - const thisSong = thisVersion.songs.find(s => s.latest)
                                                        - const displayDate = moment.utc(thisSong.date).format('MM/DD/yy')
                                                        h5 Bounce Date: #{displayDate}
                                                        form(class="row version-select" method='POST' action='/changelatest')
                                                            input(type='hidden' name='currentLatest' value=thisSong.id)
                                                            label(for='newLatest'  class='selector') choose bounce:   
                                                            select(name="newLatest" onchange='this.form.submit()')
                                                                option(value='placeholder' selected disabled) ---
                                                                - const songDates = thisVersion.songs.map(s => moment.utc(s.date).format('YY/MM/DD') + s.id).sort().reverse()
                                                                - const formattedSongDates = songDates.map(d => d[3]+d[4]+'/'+d[6]+d[7]+'/'+d[0]+d[1] + d.slice(8))
                                                                each date in formattedSongDates
                                                                    option(value=date.slice(8)) #{date.slice(0,8)}
                                                    div(class="note-box")
                                                            p Comments:
                                                            p(class='notes') #{thisSong.comments}    
                                                div(class='info-buttons')
                                                    div(class="edit" id='editbounce-' + thisSong.id) Edit This Bounce
                                                            div(class='addbox bounce hidden')
                                                                form(method='POST' action='/edit' class='fileform' encType="multipart/form-data")
                                                                    label(for='songFile') File:
                                                                    br
                                                                    input(type='file' name='songFile' class='inputfile')
                                                                    br
                                                                    label(for='songDate') Date:
                                                                    br
                                                                    input(type='date' name='songDate' required='true' value=moment.utc(thisSong.date).format('YYYY-MM-DD') class='calendar')
                                                                    br
                                                                    label(for='songComments') Comments:
                                                                    br
                                                                    input(type='textarea' spellcheck='false' name='songComments' value=thisSong.comments)
                                                                    br
                                                                    label(for="songLatest") Latest
                                                                    input(type="checkbox" name="songLatest" checked=thisSong.latest ? 'checked' : '')
                                                                    input(type='hidden' name='dataID' value='song-' + thisSong.id)
                                                                    input(type='hidden' name='versionID' value=thisVersion.id)
                                                                    button(type='submit') OK
                                                    div(class="add" id='addbounce-' + thisVersion.id) Add a New Bounce
                                                        div(class='addbox bounce hidden')
                                                            form(method='POST' action='/' encType='multipart/form-data' class='fileform' id='bounce-form-' + thisVersion.id)
                                                                label(for='songFile') File:
                                                                br
                                                                input(type='file' name='songFile' required='true' class='inputfile')
                                                                br
                                                                label(for='songDate') Date:
                                                                br
                                                                input(type='date' name='songDate' required='true' class='calendar')
                                                                br
                                                                label(for='songComments') Comments:
                                                                br
                                                                input(type='textarea' spellcheck='false' name='songComments' value='')
                                                                br
                                                                label(for="songLatest") Latest
                                                                input(type="checkbox" name="songLatest" checked)
                                                                input(type='hidden' name='dataID' value='song-' + thisVersion.id)
                                                                button(type='submit') OK                                                        
                                                    a(class='delete' href=('/delete/song/' + thisSong.id + '/' + thisVersion.id)) delete this bounce
                                        else
                                            div(class='song-con')
                                                div(class='nosong')
                                                    div(class='song')
                                                        p There are no bounces for this version.
                                                        div(class="add" id='addbounce-' + thisVersion.id) Add a New Bounce
                                                            div(class='addbox bounce hidden')
                                                                form(method='POST' action='' id='songform' class='fileform' encType="multipart/form-data")
                                                                    label(for='songFile') File:
                                                                    br
                                                                    input(type='file' name='songFile' required='true' class='inputfile')
                                                                    br
                                                                    label(for='songDate') Date:
                                                                    br
                                                                    input(type='date' name='songDate' required='true' class='calendar')
                                                                    br
                                                                    label(for='songComments') Comments:
                                                                    br
                                                                    input(type='textarea' spellcheck='false' name='songComments' value='')
                                                                    br
                                                                    label(for="songLatest") Latest
                                                                    input(type="checkbox" name="songLatest" checked)
                                                                    input(type='hidden' name='dataID' value='song-' + thisVersion.id)
                                                                    button(type='submit') OK
                                    else
                                        div(class='noversion')
                                            p No versions of this title.
                                            div(class="add" id=('addversion-' + title.id)) Add a New Version
                                                div(class='addbox hidden add-version')
                                                    form(method='POST' action='' id='versionform')
                                                        label(for='versionName') Name:
                                                        input(type='text' spellcheck='false' name='versionName' required='true' value='')
                                                        label(for='versionName') Version Notes:
                                                        input(type='textarea' spellcheck='false' name='versionNotes' value='')
                                                        label(for="versionCurrent") Current version
                                                        input(type="checkbox" name="versionCurrent" checked)
                                                        input(type='hidden' name='dataID' value='version-' + title.id)
                                                        button(type='submit') OK
                    else
                        p(class='row notitle') No songs in this tier.
        else
            p(class='row tier') There are no tiers.                       
    script
        include ../index.js